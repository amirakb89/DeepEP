name: One-way Sync - Develop to Public Main

on:
  push:
    branches:
      - develop
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync-to-public:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout deepEP_private develop branch
        uses: actions/checkout@v4
        with:
          repository: ROCm/deepEP_private
          ref: develop
          token: ${{ secrets.SYNC_PAT_TOKEN }}
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config --global user.name "GitHub Action Bot"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Add public DeepEP remote
        run: |
          git remote add public-repo https://${{ secrets.SYNC_PAT_TOKEN }}@github.com/ROCm/DeepEP.git
          git fetch public-repo main

      - name: Check sync status
        id: check_status
        run: |
          DEVELOP_COMMIT=$(git rev-parse HEAD)
          PUBLIC_MAIN_COMMIT=$(git rev-parse public-repo/main)

          echo "Develop HEAD: $DEVELOP_COMMIT"
          echo "Public main HEAD: $PUBLIC_MAIN_COMMIT"

          # Check if develop has commits not in public/main
          COMMITS_AHEAD=$(git rev-list --count public-repo/main..HEAD)
          echo "Commits ahead: $COMMITS_AHEAD"

          if [ "$COMMITS_AHEAD" -eq 0 ]; then
            echo "status=in_sync" >> $GITHUB_OUTPUT
            echo "Branches are already in sync"
          else
            echo "status=needs_sync" >> $GITHUB_OUTPUT
            echo "$COMMITS_AHEAD commit(s) to sync"
          fi

      - name: Check for merge conflicts
        id: conflict_check
        if: steps.check_status.outputs.status == 'needs_sync'
        run: |
          # Create a temporary branch from public/main
          git checkout -b temp-main-sync public-repo/main

          # Attempt merge with --no-commit to check for conflicts
          if git merge --no-commit --no-ff develop 2>/dev/null; then
            echo "conflict=false" >> $GITHUB_OUTPUT
            echo "No conflicts detected"
            # Abort the test merge
            git merge --abort || true
          else
            echo "conflict=true" >> $GITHUB_OUTPUT
            echo "CONFLICT DETECTED - Sync halted!"
            git merge --abort || true
            exit 1
          fi

      - name: Merge develop into main branch
        if: steps.check_status.outputs.status == 'needs_sync' && steps.conflict_check.outputs.conflict == 'false'
        run: |
          # Switch to main branch from public repo
          git checkout -b main-sync public-repo/main

          DEVELOP_COMMIT=$(git rev-parse develop)

          # Merge develop into main
          git merge develop -m "Sync: Merge from deepEP_private:develop to DeepEP:main

          Auto-sync via GitHub Actions
          Source commit: $DEVELOP_COMMIT"

      - name: Remove private .github folder
        if: steps.check_status.outputs.status == 'needs_sync' && steps.conflict_check.outputs.conflict == 'false'
        run: |
          # Remove .github folder from the commit (it's private-repo specific)
          if [ -d ".github" ]; then
            git rm -rf .github
            git commit --amend --no-edit
            echo "Removed .github folder from sync"
          else
            echo ".github folder not present, skipping"
          fi

      - name: Push to public repository
        if: steps.check_status.outputs.status == 'needs_sync' && steps.conflict_check.outputs.conflict == 'false'
        run: |
          git push public-repo main-sync:main
          echo "Successfully synced develop to public DeepEP:main"

      - name: Summary
        run: |
          if [ "${{ steps.check_status.outputs.status }}" == "in_sync" ]; then
            echo "No sync needed - branches already in sync"
          elif [ "${{ steps.conflict_check.outputs.conflict }}" == "true" ]; then
            echo "Sync failed due to conflicts - manual resolution required"
          else
            echo "Sync completed successfully"
          fi
