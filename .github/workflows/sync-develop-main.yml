name: "test-sync"

on:
  push:
    branches:
      - oneway-sync-workflows
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync-to-public:
    runs-on: ubuntu-latest

    steps:
      - name: Generate GitHub App Token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
          owner: ROCm
          repositories: deepEP_private,DeepEP

      - name: Checkout deepEP_private oneway-sync-workflows branch
        uses: actions/checkout@v4
        with:
          repository: ROCm/deepEP_private
          ref: oneway-sync-workflows
          token: ${{ steps.app-token.outputs.token }}
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config --global user.name "DeepEP-Sync-Bot[bot]"
          git config --global user.email "DeepEP-Sync-Bot[bot]@users.noreply.github.com"

      - name: Add public DeepEP remote
        run: |
          git remote add public-repo https://x-access-token:${{ steps.app-token.outputs.token }}@github.com/ROCm/DeepEP.git
          git fetch public-repo test-main

      - name: Check sync status
        id: check_status
        run: |
          SOURCE_COMMIT=$(git rev-parse HEAD)
          PUBLIC_TEST_MAIN_COMMIT=$(git rev-parse public-repo/test-main)

          echo "oneway-sync-workflows HEAD: $SOURCE_COMMIT"
          echo "Public test-main HEAD: $PUBLIC_TEST_MAIN_COMMIT"

          # Check if oneway-sync-workflows has commits not in public/test-main
          COMMITS_AHEAD=$(git rev-list --count public-repo/test-main..HEAD)
          echo "Commits ahead: $COMMITS_AHEAD"

          if [ "$COMMITS_AHEAD" -eq 0 ]; then
            echo "status=in_sync" >> $GITHUB_OUTPUT
            echo "Branches are already in sync"
          else
            echo "status=needs_sync" >> $GITHUB_OUTPUT
            echo "$COMMITS_AHEAD commit(s) to sync"
          fi

      - name: Check for merge conflicts
        id: conflict_check
        if: steps.check_status.outputs.status == 'needs_sync'
        run: |
          # Create a temporary branch from public/test-main
          git checkout -b temp-test-main-sync public-repo/test-main

          # Attempt merge with --no-commit to check for conflicts
          if git merge --no-commit --no-ff oneway-sync-workflows 2>/dev/null; then
            echo "conflict=false" >> $GITHUB_OUTPUT
            echo "No conflicts detected"
            # Abort the test merge
            git merge --abort || true
          else
            echo "conflict=true" >> $GITHUB_OUTPUT
            echo "CONFLICT DETECTED - Sync halted!"
            git merge --abort || true
            exit 1
          fi

      - name: Merge oneway-sync-workflows into test-main branch
        if: steps.check_status.outputs.status == 'needs_sync' && steps.conflict_check.outputs.conflict == 'false'
        run: |
          # Switch to test-main branch from public repo
          git checkout -b test-main-sync public-repo/test-main

          SOURCE_COMMIT=$(git rev-parse oneway-sync-workflows)

          # Merge oneway-sync-workflows into test-main
          git merge oneway-sync-workflows -m "Sync: Merge from deepEP_private:oneway-sync-workflows to DeepEP:test-main

          Auto-sync via GitHub Actions (TEST)
          Source commit: $SOURCE_COMMIT"

      - name: Remove private .github folder
        if: steps.check_status.outputs.status == 'needs_sync' && steps.conflict_check.outputs.conflict == 'false'
        run: |
          # Remove .github folder from the commit (it's private-repo specific)
          if [ -d ".github" ]; then
            git rm -rf .github
            git commit --amend --no-edit
            echo "Removed .github folder from sync"
          else
            echo ".github folder not present, skipping"
          fi

      - name: Push to public repository
        if: steps.check_status.outputs.status == 'needs_sync' && steps.conflict_check.outputs.conflict == 'false'
        run: |
          git push public-repo test-main-sync:test-main
          echo "Successfully synced oneway-sync-workflows to public DeepEP:test-main"

      - name: Summary
        run: |
          if [ "${{ steps.check_status.outputs.status }}" == "in_sync" ]; then
            echo "No sync needed - branches already in sync"
          elif [ "${{ steps.conflict_check.outputs.conflict }}" == "true" ]; then
            echo "Sync failed due to conflicts - manual resolution required"
          else
            echo "Sync completed successfully"
          fi

