name: Test One-way Sync - Develop to Public Main

on:
  push:
    branches:
      - oneway-sync-workflows
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync-to-public:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout deepEP_private develop branch
        uses: actions/checkout@v4
        with:
          repository: ROCm/deepEP_private
          ref: oneway-sync-workflows
          token: ${{ secrets.SYNC_PAT_TOKEN }}
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config --global user.name "GitHub Action Bot"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Add public DeepEP remote
        run: |
          git remote add public-repo https://${{ secrets.SYNC_PAT_TOKEN }}@github.com/ROCm/DeepEP.git
          git fetch public-repo test-main

      - name: Check sync status
        id: check_status
        run: |
          DEVELOP_COMMIT=$(git rev-parse HEAD)
          PUBLIC_MAIN_COMMIT=$(git rev-parse public-repo/test-main)

          echo "Develop HEAD: $DEVELOP_COMMIT"
          echo "Public main HEAD: $PUBLIC_MAIN_COMMIT"

          # Check if develop has commits not in public/main
          COMMITS_AHEAD=$(git rev-list --count public-repo/test-main..HEAD)
          echo "Commits ahead: $COMMITS_AHEAD"

          if [ "$COMMITS_AHEAD" -eq 0 ]; then
            echo "status=in_sync" >> $GITHUB_OUTPUT
            echo "Branches are already in sync"
          else
            echo "status=needs_sync" >> $GITHUB_OUTPUT
            echo "$COMMITS_AHEAD commit(s) to sync"
          fi

      - name: Check for merge conflicts
        id: conflict_check
        if: steps.check_status.outputs.status == 'needs_sync'
        run: |
          # Create a temporary branch from public/main
          git checkout -b temp-main-sync public-repo/test-main

          # Attempt merge with --no-commit to check for conflicts
          if git merge --no-commit --no-ff oneway-sync-workflows 2>/dev/null; then
            echo "conflict=false" >> $GITHUB_OUTPUT
            echo "No conflicts detected"
            # Abort the test merge
            git merge --abort || true
          else
            echo "conflict=true" >> $GITHUB_OUTPUT
            echo "CONFLICT DETECTED - Sync halted!"
            echo ""
            echo "=========================================="
            echo "MANUAL INTERVENTION REQUIRED"
            echo "=========================================="
            echo "Conflicts exist between:"
            echo "  - Source: ROCm/deepEP_private:oneway-sync-workflow"
            echo "  - Target: ROCm/DeepEP:main"
            echo ""
            echo "Please resolve conflicts manually before syncing."
            echo "=========================================="
            git merge --abort || true
            exit 1
          fi

      - name: Merge develop into main branch
        if: steps.check_status.outputs.status == 'needs_sync' && steps.conflict_check.outputs.conflict == 'false'
        run: |
          # Switch to main branch from public repo
          git checkout -b test-main-sync public-repo/test-main

          DEVELOP_COMMIT=$(git rev-parse oneway-sync-workflows)

          # Merge develop into main
          #git merge develop -m "Sync: Merge from deepEP_private:develop to DeepEP:test-main
          git merge oneway-sync-workflows -m "Sync: Merge from deepEP_private:oneway-sync-workflows
          Auto-sync via GitHub Actions
          Source commit: $DEVELOP_COMMIT"

      - name: Push to public repository
        if: steps.check_status.outputs.status == 'needs_sync' && steps.conflict_check.outputs.conflict == 'false'
        run: |
          git push public-repo test-main-sync:test-main
          echo "Successfully synced develop to public DeepEP:main"

      - name: Summary
        run: |
          if [ "${{ steps.check_status.outputs.status }}" == "in_sync" ]; then
            echo "ℹ️ No sync needed - branches already in sync"
          elif [ "${{ steps.conflict_check.outputs.conflict }}" == "true" ]; then
            echo "Sync failed due to conflicts - manual resolution required"
          else
            echo "Sync completed successfully"
          fi
